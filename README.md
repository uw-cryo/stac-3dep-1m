# stac-3dep-1m
Static STAC Catalog + STAC GeoParquet for 3DEP 1m DEMs from here (https://prd-tnm.s3.amazonaws.com/index.html?prefix=StagedProducts/Elevation/1m)


This repository contains scripts to create a static STAC catalog of 3DEP 1m DEMs hosted on AWS. It creates Static STAC Item JSON generated by TiTiler https://titiler.xyz/api.html for each 1m TIFF, and at the end saves a single STAC GeoParquet file with all the Items.

You can access the GeoParquet as a release asset. Or browse the static STAC catalog with STAC Browser:

https://radiantearth.github.io/stac-browser/#/external/raw.githubusercontent.com/uw-cryo/stac-3dep-1m/refs/heads/main/catalog/catalog.json


## Usage

```
pixi run create-stac --project  WA_KingCounty_2021_B21 --overwrite
```

```
pixi run create-all
```

```
pixi run catalog-to-geoparquet
```


## Development notes

* Some 1m data is stored under a workunit rather than project subfolder:
Workunit: TX_RedRiver_3Area_B2_2018
Project: TX_Red_River_FEMA_R6_Lidar_2016_D17
1m url by workunit: https://prd-tnm.s3.amazonaws.com/StagedProducts/Elevation/1m/Projects/TX_RedRiver_3Area_B2_2018/0_file_download_links.txt

* Raise a warning if one_meter_category is not 'Meets' (also copy this info into collection level metadata)

create_static_stac.py:101: UserWarning: Project 'CA_SouthernSierra_2020_B20' onemeter_category is not 'Meets' but 'Pending publication'


### First release processing failures


### Some 1m tiffs stored neither by workunit or project name (e.g. not sure where 'BAA' comes from in folder name below):
AR_BentonCoBAA_2015
https://prd-tnm.s3.amazonaws.com/index.html?prefix=StagedProducts/Elevation/1m/Projects/AR_BentonCoBAA_2015/

workunit                                              AR_Benton_Co_2015
project                                                  AR_Benton_2015

CA_Eastern_SanDiegoCo_2016/
https://prd-tnm.s3.amazonaws.com/index.html?prefix=StagedProducts/Elevation/1m/Projects/CA_Eastern_SanDiegoCo_2016/
workunit                                           CA_E_SanDiegoCo_2016
project                          CA_Eastern_San_Diego_Co_Lidar_2016_B16

### Duplicate TIFFs in 0_file_download_links.txt

* CA_FEMAR9PanocheSanLuis_2019_D20
   - https://prd-tnm.s3.amazonaws.com/StagedProducts/Elevation/1m/Projects/CA_FEMAR9PanocheSanLuis_2019_D20/0_file_download_links.txt

Note: file list has both `USGS_1M` and `USGS_1m` lowercase m, but actually TIFFs only stored by `1M`

https://github.com/OpenTopography/Data_Catalog_Spatial_Boundaries/blob/main/USGS_3DEP/CA_FEMAR9PanocheSanLuis_2019.geojson


### Overlapping source data

Single seamless cell, multiple tiffs:

These tend to have just a little bit of valid data on the edges:
* USGS_1M_10_x69y406_CA_CaliforniaGaps_B23
* USGS_1M_10_x69y406_CA_SanJoaquin_2021_A21

More coverage
* USGS_1M_10_x69y406_CA_FEMAR9PanocheSanLuis_2019_D20

### No TIFFs despite 1m folder:

* CA_LakeCounty_2015/

* TX_EastTexas_2017_A17


### No 0_file_download_links.txt

Processing script relies on presence of 0_file_download_links.txt to list all the tiffs. Some folders don't have this:

```
{'CA_LakeCounty_2015',
 'CA_SanDiegoQL2_2014',
 'MA_NE_CMGP_Sandy_Z18_2013',
 'ME_Western_2016',
 'MI_13Co_BerrienCO_2015',
 'MI_13Co_Emmett_2015',
 'MI_13Co_VanBurrenCo_2015',
 'MI_25County_AlleganCo_2015',
 'MI_31Co_Ottawa_2016',
 'MI_AlgerCo_2015',
 'MI_Baraga_2015',
 'MI_BenzieCo_2015',
 'MI_BranchCo_2017',
 'MI_CalhounCo_2017',
 'MI_DeltaCo_2015',
 'MI_GrandTraverseCO_2015',
 'MI_HiawathaNF_QL1_2018',
 'MI_HiawathaNF_QL2_2018',
 'MI_LeelanauCo_2015',
 'MI_MackinacCo_2015',
 'MI_ManisteeCo_2015',
 'MI_Marquette_2015',
 'NM_NorthCentral_B2_2016',
 'NM_RioSanJose_2016',
 'NY_ClintonEssexLakeChamplain_2014',
 'NY_SouthwestNY_2017_A17',
 'SD_NRCS_QSI_A1_2017',
 'SD_NRCS_QSI_A2_2017'}
```



### json.decoder.JSONDecodeError: Expecting value: line 1 column 1 (char 0)

Possible read failures if titiler STAC generation fails...
* WI_Bayfield_2016

Running as single workunit worked!
```
python scripts/create_static_stac.py --workunit WI_Bayfield_2016
```


### Rate-limiting from titiler server

NOTE: sometimes get this from server:
creating STAC Items from 163 tifs...
```
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<TITLE>ERROR: The request could not be satisfied</TITLE>
</HEAD><BODY>
<H1>403 ERROR</H1>
<H2>The request could not be satisfied.</H2>
<HR noshade size="1px">
Request blocked.
We can't connect to the server for this app or website at this time. There might be too much traffic or a configuration error. Try again later, or contact the app or website owner.
<BR clear="all">
If you provide content to customers through CloudFront, you can find steps to troubleshoot and help prevent this error by reviewing the CloudFront documentation.
<BR clear="all">
<HR noshade size="1px">
<PRE>
Generated by cloudfront (CloudFront)
Request ID: GuGy4HUODNobDBWobDe-KWE5wb8Ln3VObFpzmze1gJ41vyzQnG-2Mg==
</PRE>
<ADDRESS>
</ADDRESS>
</BODY></HTML>
```

NOTE: best solution is to deploy your own! Otherwise, avoid async requests or add 0.5s delay in between requests.



### pystac.errors.STACTypeError: JSON (id = unknown) does not represent a STACObject instance. 'type' attribute is not set

```
python scripts/create_static_stac.py --project WI_Statewide_2019_A19
```

One problematic tiff causes entire workunit to fail:

{"detail":"Too many bins for data range. Cannot create 10 finite-sized bins."}

https://titiler.xyz/cog/stac?id=USGS_1M_15_x56y492_WI_Statewide_2019_A19&datetime=2019-04-08T00:00:00Z/2019-04-08T00:00:00Z&collection=WI_Statewide_2019_A19&asset_name=elevation&asset_roles=data&with_eo=false&url=https://prd-tnm.s3.amazonaws.com/StagedProducts/Elevation/1m/Projects/WI_Statewide_2019_A19/TIFF/USGS_1M_15_x56y492_WI_Statewide_2019_A19.tif

Very strange! Little valid blob in middle of mississippi river, maybe passing ship, barge, or seasonal island...

Solution: with_raster=True to skip histogram generation
